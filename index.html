<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Basketball - Analyse Coach</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://apis.google.com/js/api.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        @keyframes gradientShift {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
			/*background: radial-gradient(circle, #ffffff, #414141, #000000);*/
			background: #dfdfdf;
			background-size: 1000% 1000%;
			animation: gradientShift 5s ease-in-out infinite;
			background-position: center;
			margin: 0;
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 5px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            position: relative;
        }

        .header h1 {
            color: #2c3e50;
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .header .subtitle {
            color: #7f8c8d;
            font-size: 1.1rem;
            font-weight: 400;
        }

        /* Bouton Paramètres dans le header */
        .settings-btn {
            position: absolute;
            top: 20px;
            right: 20px;
			/*background: linear-gradient(135deg, #667eea, #764ba2);*/
            background: #764ba2;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 1rem;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .settings-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        /* Section Paramètres */
        .settings-section {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 5px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease-in-out;
            overflow: hidden;
        }

        .settings-section.hidden {
            max-height: 0;
            padding: 0;
            margin-bottom: 0;
            opacity: 0;
            display: none;
        }

        .settings-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-top: 20px;
        }

        .settings-panel {
            background: white;
            padding: 20px;
            border-left: 4px solid #3498db;
        }

        .settings-panel h3 {
            margin: 0 0 15px 0;
            color: #2c3e50;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 1rem;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.3);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #9b59b6, #8e44ad);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 1rem;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 10px;
        }

        .btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(155, 89, 182, 0.3);
        }

        .connection-option {
            margin-bottom: 15px;
        }

        .connection-option label {
            display: block;
            font-weight: 600;
            color: #34495e;
            margin-bottom: 8px;
        }

        .connection-option select,
        .connection-option input[type="text"],
        .connection-option input[type="file"] {
            width: 100%;
            padding: 10px;
            border: 2px solid #e8e8e8;
            border-radius: 5px;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .connection-option select:focus,
        .connection-option input:focus {
            border-color: #3498db;
            outline: none;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
        }

        .connection-details {
            margin-top: 15px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 5px;
            display: none;
        }

        .connection-details.visible {
            display: block;
        }

        .filters-section {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 5px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .filters-title {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
            color: #2c3e50;
            font-size: 1.3rem;
            font-weight: 600;
        }

        #businessRulesContent {
            transition: max-height 0.3s ease-in-out, opacity 0.3s ease-in-out;
            overflow: hidden;
        }

        #toggleBusinessRulesBtn {
            transition: all 0.2s ease;
        }

        #toggleBusinessRulesBtn:hover {
            background: #2980b9 !important;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .filters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .filter-group label {
            font-weight: 600;
            color: #34495e;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .filter-control {
            padding: 12px 15px;
            border: 2px solid #e8e8e8;
            border-radius: 8px;
            background: white;
            font-size: 14px;
            transition: all 0.3s ease;
            outline: none;
        }

        .filter-control:focus {
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
        }

        .checkbox-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 8px;
            background: #f8f9fa;
            padding: 8px 12px;
            border-radius: 5px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 2px solid transparent;
        }

        .checkbox-item:hover {
            background: #e9ecef;
        }

        .checkbox-item.active {
            background: #3498db;
            color: white;
			box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .checkbox-item input {
            display: none;
        }

        .stats-overview {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 0 5px 5px 0;
            padding: 25px;
            text-align: center;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.15);
        }

        .stat-icon {
            width: 50px;
            height: 50px;
            margin: 0 auto 15px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.5rem;
        }

        .stat-value {
            font-size: 2.5rem;
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 5px;
        }

        .stat-label {
            color: #7f8c8d;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-size: 0.9rem;
        }

        .charts-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

		.charts-section.full-width {
			grid-template-columns: 1fr;
		}

        .chart-container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 5px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            height: 400px;
        }

        .chart-container canvas {
            max-height: 320px !important;
        }

        .chart-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .players-section {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 5px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .stats-filter-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 15px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.7);
            border-radius: 8px;
            border: 1px solid rgba(52, 152, 219, 0.2);
        }

        .stat-filter-btn {
            /*padding: 8px 16px;
            background: #e9ecef;
            color: #7f8c8d;
            border: 2px solid #dee2e6;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
            transition: all 0.3s ease;
            text-transform: capitalize;*/
			
			display: flex;
            align-items: center;
            gap: 8px;
            background: #f8f9fa;
            padding: 8px 12px;
            border-radius: 5px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 2px solid transparent;
			
        }

        .stat-filter-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .stat-filter-btn.active {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            border-color: #3498db;
            box-shadow: 0 4px 12px rgba(52, 152, 219, 0.3);
        }

        .players-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .player-card {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            padding: 20px;
            border-left: 5px solid #3498db;
            transition: all 0.3s ease;
        }

        .player-card:hover {
            transform: translateX(5px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }

        .player-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 15px;
        }

        .player-name {
            font-size: 1.2rem;
            font-weight: 700;
            color: #2c3e50;
			margin-right: 10px;
        }

        .player-number {
            background: #3498db;
            color: white;
            padding: 5px 12px;
            border-radius: 5px;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .player-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
        }

        .player-stat {
            text-align: center;
            padding: 8px;
            background: white;
            border-radius: 8px;
        }

        .player-stat-value {
            font-size: 1.1rem;
            font-weight: 600;
            color: #2c3e50;
        }

        .player-stat-label {
            font-size: 0.8rem;
            color: #7f8c8d;
            text-transform: uppercase;
        }

        .no-data {
            text-align: center;
            color: #7f8c8d;
            font-style: italic;
            padding: 40px;
        }

        @media (max-width: 768px) {
            .charts-section {
                grid-template-columns: 1fr;
            }

            .filters-grid {
                grid-template-columns: 1fr;
            }

            .header h1 {
                font-size: 2rem;
            }

            .settings-grid {
                grid-template-columns: 1fr;
            }
        }

        .category-config-item {
            display: flex;
            align-items: center;
            gap: 8px;
            background: #f8f9fa;
            padding: 10px 15px;
            border-radius: 8px;
            font-size: 13px;
            cursor: move;
            transition: all 0.2s ease;
            border: 2px solid transparent;
            margin-bottom: 8px;
            user-select: none;
        }

        .category-config-item:hover {
            background: #e9ecef;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .category-config-item.positive {
            background: rgba(44, 90, 160, 0.1);
            border-color: #2c5aa0;
            color: #2c5aa0;
        }

        .category-config-item.negative {
            background: rgba(220, 38, 38, 0.1);
            border-color: #dc2626;
            color: #dc2626;
        }

        .category-config-item.dragging {
            opacity: 0.7;
            transform: rotate(5deg);
        }

        .category-drop-zone {
            min-height: 100px;
            border: 2px dashed #bdc3c7;
            border-radius: 8px;
            padding: 15px;
            transition: all 0.3s ease;
        }

        .category-drop-zone.drag-over {
            border-color: #3498db;
            background: rgba(52, 152, 219, 0.05);
        }

        .category-drop-zone.positive {
            border-color: #2c5aa0;
        }

        .category-drop-zone.negative {
            border-color: #dc2626;
        }

        .remove-from-category {
            background: #e74c3c;
            color: white;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-left: auto;
        }

        .remove-from-category:hover {
            background: #c0392b;
        }

        .reset-filters {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            margin-top: 15px;
        }

        .reset-filters:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(231, 76, 60, 0.3);
        }

        .file-upload {
            margin-bottom: 20px;
        }

        .file-upload-area {
            border: 2px dashed #bdc3c7;
            border-radius: 12px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.9);
        }

        .file-upload-area:hover {
            border-color: #3498db;
            background: rgba(52, 152, 219, 0.05);
        }

        .file-upload-area.dragover {
            border-color: #2ecc71;
            background: rgba(46, 204, 113, 0.1);
        }

		.uncategorized-section {
			background: rgba(255, 255, 255, 0.95);
			backdrop-filter: blur(10px);
			border-radius: 12px;
			padding: 20px;
			box-shadow: 0 4px 16px rgba(0, 0, 0, 0.05);
			border: 1px solid rgba(255, 255, 255, 0.2);
			width: 100%;
			margin-top: 20px;
		}

		.uncategorized-actions {
			transition: all 0.3s ease;
			width: 100%;
		}

		.category-config-item.uncategorized:hover {
			background: #f8f9fa !important;
			transform: translateY(-1px);
			box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
		}

        #csvFileInput {
            display: none;
        }

        #importConfigInput {
            display: none;
        }

        .info-box {
            background: rgba(52, 152, 219, 0.1);
            border-left: 4px solid #3498db;
            padding: 12px;
            margin-top: 15px;
            font-size: 0.9rem;
            color: #2c3e50;
        }

        .info-box code {
            background: rgba(0, 0, 0, 0.1);
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>🏀 Dashboard Basketball</h1>
            <p class="subtitle">Analyse des performances pour le basket</p>
            <button class="settings-btn" onclick="toggleSettings()">
                ⚙️ Paramètres
            </button>
        </div>

        <!-- Section Paramètres (cachée par défaut) -->
        <div id="settingsSection" class="settings-section hidden">
            <div class="filters-title">⚙️ Paramètres du Dashboard</div>

            <div class="settings-grid">
                <!-- Import / Export Configuration -->
                <div class="settings-panel">
                    <h3>📊 Import / Export stats</h3>
                    <button class="btn-primary" onclick="exportConfiguration()">
                        💾 Export stats
                    </button>
                    <button class="btn-secondary" onclick="document.getElementById('importConfigInput').click()">
                        📂 Import stats
                    </button>
                    <input type="file" id="importConfigInput" accept=".json" onchange="importConfiguration(event)">
                    <div class="info-box">
                        Exporte et importe la configuration complète incluant les catégories d'actions et les règles métier créées.
                    </div>
                </div>

                <!-- Connexion données par défaut -->
                <div class="settings-panel">
                    <h3>🔗 Connexion données par défaut</h3>
                    <div class="connection-option">
                        <label>Source de données :</label>
                        <select id="dataSourceSelect" onchange="handleDataSourceChange()" class="filter-control">
                            <option value="none">Aucune</option>
                            <option value="local">Locale</option>
                            <option value="googleDrive">Google Drive</option>
                        </select>
                    </div>

                    <!-- Option Locale -->
                    <div id="localConnection" class="connection-details">
                        <label>Chemin du fichier local :</label>
                        <div style="display: flex; gap: 10px; margin-top: 8px;">
                            <input type="text" id="localFilePath" placeholder="Chemin complet du fichier CSV" readonly>
                            <button class="btn-primary" style="margin: 0;" onclick="document.getElementById('localFileInput').click()">
                                Choisir
                            </button>
                        </div>
                        <input type="file" id="localFileInput" accept=".csv" style="display: none;" onchange="handleLocalFileSelection(event)">
                        <div class="info-box" style="margin-top: 10px;">
                            Les données de ce fichier seront chargées automatiquement au démarrage.
                        </div>
                    </div>

                    <!-- Option Google Drive -->
                    <div id="googleDriveConnection" class="connection-details">
                        <label>URL du Google Sheet :</label>
                        <input type="text" id="googleSheetUrl" placeholder="https://docs.google.com/spreadsheets/d/...">
                        <div style="display: flex; gap: 10px; margin-top: 10px;">
                            <button class="btn-primary" style="margin: 0;" onclick="saveGoogleSheetUrl()">
                                💾 Enregistrer l'URL
                            </button>
                            <button class="btn-secondary" style="margin: 0; background: linear-gradient(135deg, #2ecc71, #27ae60);" onclick="testGoogleSheetConnection()">
                                🔍 Tester la connexion
                            </button>
                        </div>
                        <div class="info-box" style="margin-top: 10px;">
                            <strong>💡 Formats d'URL acceptés :</strong><br>
                            • URL d'édition : <code>/d/DOCUMENT_ID/edit</code><br>
                            • URL de publication : <code>/d/e/DOCUMENT_ID/pub?output=csv</code><br>
                            • URL d'export : <code>/d/DOCUMENT_ID/export?format=csv</code><br><br>
                            <strong>📌 Important :</strong> Le fichier doit être publié (Fichier > Partager > Publier sur le Web)
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Upload CSV -->
        <div class="file-upload">
            <div class="file-upload-area" onclick="document.getElementById('csvFileInput').click()"
                 ondrop="handleFileDrop(event)" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)">
                <p><strong>📁 Cliquez ici ou glissez votre fichier CSV</strong></p>
                <p>Format attendu: Date,Adversaire,Joueur,Numéro,Période,Temps,Action</p>
                <input type="file" id="csvFileInput" accept=".csv" onchange="handleFileUpload(event)">
            </div>
        </div>

        <!-- Filtres -->
        <div class="filters-section">
            <div class="filters-title">
                🔍 Filtres Multi-Critères
            </div>
            <div class="filters-grid">
                <div class="filter-group">
                    <label>Date du match</label>
                    <select id="dateFilter" class="filter-control" onchange="applyFilters()">
                        <option value="">Toutes les dates</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Adversaire</label>
                    <select id="adversaireFilter" class="filter-control" onchange="applyFilters()">
                        <option value="">Tous les adversaires</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Période</label>
                    <select id="quartFilter" class="filter-control" onchange="applyFilters()">
                        <option value="">Toutes les périodes</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Joueurs sélectionnés</label>
                    <div id="playersCheckboxes" class="checkbox-group">
                        <!-- Dynamiquement rempli -->
                    </div>
                </div>
            </div>
            <div class="filter-group">
                <label>Actions à analyser</label>
                <div id="actionsCheckboxes" class="checkbox-group">
                    <!-- Dynamiquement rempli -->
                </div>
            </div>
            <button class="reset-filters" onclick="resetAllFilters()" style="padding:10px;margin-top:10px;border-radius:5px">🔄 Réinitialiser tous les filtres</button>
            <button class="reset-filters" onclick="exportFilteredData()" style="background: #2ecc71;padding:10px;margin-top:10px;margin-left:10px;border-radius:5px">📊 Exporter les données filtrées</button>
        </div>

        <!-- Configuration des catégories -->
        <div class="filters-section">
            <div class="filters-title">
                ⚙️ Configuration des catégories d'actions
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-top: 20px;">
                <div>
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px;">
                        <div style="width: 20px; height: 20px; background: #2c5aa0;"></div>
                        <label style="font-weight: 600; color: #2c5aa0; font-size: 1.1rem;">Actions Positives</label>
                    </div>
                    <div id="positiveActionsConfig" class="checkbox-group">
                        <!-- Dynamiquement rempli -->
                    </div>
                </div>
                <div>
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px;">
                        <div style="width: 20px; height: 20px; background: #dc2626; border-radius: 4px;"></div>
                        <label style="font-weight: 600; color: #dc2626; font-size: 1.1rem;">Actions Négatives</label>
                    </div>
                    <div id="negativeActionsConfig" class="checkbox-group">
                        <!-- Dynamiquement rempli -->
                    </div>
                </div>
            </div>
            <div style="margin-top: 20px; padding: 15px; background: rgba(52, 152, 219, 0.1); border-left: 4px solid #3498db;">
                <p style="margin: 0; color: #2c3e50; font-size: 0.9rem;">
                    <strong>💡 Astuce :</strong> Glissez les actions entre les catégories pour personnaliser votre analyse.
                    Les actions non catégorisées n'apparaîtront que dans les graphiques généraux.
                </p>
            </div>
            <button class="reset-filters" onclick="resetCategorization()" style="background: #e67e22;padding:10px;margin-top:10px;border-radius:5px">
                🔄 Réinitialiser la catégorisation
            </button>
        </div>

		<!-- Gestion des règles métier -->
		<div class="filters-section" id="businessRulesSection">
			<div class="filters-title">
				🎯 Gestion des règles métier
				<button onclick="toggleBusinessRulesSection()" id="toggleBusinessRulesBtn"
						style="margin-left: auto; background: #3498db; color: white; border: none;
							   padding: 8px 16px; border-radius: 5px; cursor: pointer; font-size: 0.9rem;
							   display: flex; align-items: center; gap: 5px;">
					<span id="toggleIcon">📈</span> Développer / réduire
				</button>
			</div>

			<!-- Contenu collapsible -->
			<div id="businessRulesContent" style="display: none;">
				<!-- Bandeau d'activation/désactivation -->
				<div style="background: rgba(52, 152, 219, 0.1); border-radius: 8px; padding: 15px; margin-bottom: 20px;">
					<div style="display: flex; align-items: center; gap: 10px; flex-wrap: wrap;">
						<button class="reset-filters" onclick="toggleAllRules()" style="padding: 8px 15px; margin: 0; font-size: 0.9rem;" id="toggleAllRulesBtn">
							✅ Tout désactiver
						</button>
						<div style="border-left: 2px solid #3498db; height: 30px;"></div>
						<div id="rulesToggleContainer" style="display: flex; gap: 8px; flex-wrap: wrap; flex: 1;">
							<span style="color: #7f8c8d; font-style: italic;">Aucune règle créée</span>
						</div>
					</div>
				</div>

				<!-- Formulaire de création -->
				<div style="background: white; border-radius: 8px; padding: 20px; margin-bottom: 20px;">
					<h3 style="margin: 0 0 15px 0; color: #2c3e50;">➕ Créer une nouvelle règle</h3>

					<div style="display: grid; gap: 15px;">
						<div>
							<label style="display: block; margin-bottom: 5px; font-weight: 600; color: #34495e;">Nom de la règle</label>
							<input type="text" id="ruleNameInput" placeholder="Ex: Possession efficace"
								   style="width: 100%; padding: 10px; border: 2px solid #e8e8e8; border-radius: 5px; font-size: 14px;">
						</div>

						<div>
							<label style="display: block; margin-bottom: 5px; font-weight: 600; color: #34495e;">
								Séquence d'actions (dans l'ordre chronologique)
							</label>
							<div id="ruleActionsSelector" style="min-height: 100px; border: 2px dashed #bdc3c7; border-radius: 8px; padding: 15px; background: #f8f9fa;">
								<p style="color: #7f8c8d; font-style: italic; margin: 0;">Importez d'abord un fichier CSV pour voir les actions disponibles</p>
							</div>
							<div id="selectedActionsPreview" style="margin-top: 10px; display: flex; gap: 5px; flex-wrap: wrap; min-height: 40px; align-items: center;">
								<span style="color: #7f8c8d; font-size: 0.9rem;">Séquence : <span id="sequencePreview">vide</span></span>
							</div>
						</div>

						<div>
							<label style="display: block; margin-bottom: 5px; font-weight: 600; color: #34495e;">Type de règle</label>
							<div style="display: flex; gap: 15px;">
								<label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
									<input type="radio" name="ruleType" value="positive" checked>
									<span style="color: #2c5aa0; font-weight: 600;">✅ Positive</span>
								</label>
								<label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
									<input type="radio" name="ruleType" value="negative">
									<span style="color: #dc2626; font-weight: 600;">❌ Négative</span>
								</label>
							</div>
						</div>

						<button onclick="createBusinessRule()" style="background: linear-gradient(135deg, #2ecc71, #27ae60); color: white; border: none; padding: 12px 25px; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 1rem;">
							➕ Créer la règle
						</button>
					</div>
				</div>

				<!-- Liste des règles existantes -->
				<div style="background: white; border-radius: 8px; padding: 20px;">
					<h3 style="margin: 0 0 15px 0; color: #2c3e50;">📋 Règles existantes</h3>
					<div id="rulesListContainer">
						<p style="color: #7f8c8d; font-style: italic; text-align: center; padding: 20px;">Aucune règle créée pour le moment</p>
					</div>
				</div>
			</div>
		</div>

        <!-- Vue d'ensemble statistiques -->
        <div class="stats-overview" id="statsOverview">
            <div class="stat-card">
                <div class="stat-icon">🎯</div>
                <div class="stat-value" id="totalActions">0</div>
                <div class="stat-label">Actions totales</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">⚡</div>
                <div class="stat-value" id="totalPoints">0</div>
                <div class="stat-label">Points marqués</div>
            </div>
            <div class="stat-card" style="border-left: 8px solid #2c5aa0;">
                <div class="stat-icon" style="background: linear-gradient(135deg, #2c5aa0, #1e3a8a);">✅</div>
                <div class="stat-value" id="positiveActions" style="color: #2c5aa0;">0</div>
                <div class="stat-label">Actions positives</div>
            </div>
            <div class="stat-card" style="border-left: 8px solid #dc2626;">
                <div class="stat-icon" style="background: linear-gradient(135deg, #dc2626, #991b1b);">❌</div>
                <div class="stat-value" id="negativeActions" style="color: #dc2626;">0</div>
                <div class="stat-label">Actions négatives</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">👥</div>
                <div class="stat-value" id="activePlayersCount">0</div>
                <div class="stat-label">Joueurs actifs</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">🏆</div>
                <div class="stat-value" id="matchesCount">0</div>
                <div class="stat-label">Matchs analysés</div>
            </div>
        </div>

        <!-- Graphiques -->
        <div class="charts-section full-width">
            <div class="chart-container">
                <div class="chart-title">📊 Performance par joueur (positives vs négatives)</div>
                <canvas id="playersChart" width="400" height="300"></canvas>
            </div>
            <div class="chart-container full-width">
                <div class="chart-title">⏰ Performance par période (positives vs négatives)</div>
                <canvas id="quartersChart" width="400" height="300"></canvas>
            </div>
        </div>

        <div class="charts-section full-width">
            <div class="chart-container">
                <div class="chart-title">🎯 Types d'actions</div>
                <canvas id="actionsChart" width="400" height="300"></canvas>
            </div>
            <div class="chart-container full-width">
                <div class="chart-title">📈 Évolution temporelle (positives vs négatives)</div>
                <canvas id="timelineChart" width="400" height="300"></canvas>
            </div>
        </div>

        <div class="charts-section full-width">
            <div class="chart-container">
                <div class="chart-title">🏆 Classement joueurs par performance (différentiel)</div>
                <canvas id="performanceRankingChart" width="400" height="300"></canvas>
            </div>
            <div class="chart-container full-width">
                <div class="chart-title">📊 Répartition équilibre/déséquilibre</div>
                <canvas id="balanceChart" width="400" height="300"></canvas>
            </div>
        </div>

		<div class="charts-section full-width">
			<div class="chart-container">
				<div class="chart-title">📊 Types d'actions par période</div>
				<canvas id="actionsByQuarterChart" width="400" height="300"></canvas>
			</div>
			<div class="chart-container full-width">
				<div class="chart-title">📈 Types d'actions par match</div>
				<canvas id="actionsByMatchChart" width="400" height="300"></canvas>
			</div>
		</div>

        <!-- Détail des joueurs -->
        <div class="players-section">
            <div class="chart-title">👤 Analyse détaillée des joueurs</div>

            <!-- Filtrage des statistiques -->
            <div class="stats-filter-container" id="statsFilterContainer">
                <!-- Boutons générés dynamiquement -->
            </div>

            <div class="players-grid" id="playersGrid">
                <!-- Dynamiquement rempli -->
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // VARIABLES GLOBALES
        // ============================================
        let basketballData = [];
        let filteredData = [];
        let charts = {};
        let customPositiveActions = [];
        let customNegativeActions = [];
        let selectedStats = []; // Sera rempli dynamiquement avec les actions du CSV

		let businessRules = [];
		let ruleMatches = [];
		let nextRuleId = 1;

		// États de sections
		let businessRulesSectionCollapsed = true;
        let settingsSectionVisible = false;

        // Configuration de connexion aux données
        let dataSourceConfig = {
            type: 'none', // 'none', 'local', 'googleDrive'
            localFilePath: '',
            localFileData: null,
            googleSheetUrl: ''
        };

        // ============================================
        // GESTION DES PARAMÈTRES
        // ============================================

        function toggleSettings() {
            const settingsSection = document.getElementById('settingsSection');
            settingsSectionVisible = !settingsSectionVisible;

            if (settingsSectionVisible) {
                settingsSection.classList.remove('hidden');
            } else {
                settingsSection.classList.add('hidden');
            }
        }

        function exportConfiguration() {
            const config = {
                version: "1.0",
                exportDate: new Date().toISOString(),
                customPositiveActions: customPositiveActions,
                customNegativeActions: customNegativeActions,
                businessRules: businessRules,
                dataSourceConfig: {
                    type: dataSourceConfig.type,
                    googleSheetUrl: dataSourceConfig.googleSheetUrl
                    // Ne pas exporter localFileData pour des raisons de taille
                }
            };

            const jsonContent = JSON.stringify(config, null, 2);
            const blob = new Blob([jsonContent], { type: 'application/json;charset=utf-8;' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `basketball_config_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            window.URL.revokeObjectURL(url);

            alert('✅ Configuration exportée avec succès !');
        }

        function importConfiguration(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const config = JSON.parse(e.target.result);

                    if (!config.version || !config.customPositiveActions) {
                        alert('❌ Format de fichier invalide');
                        return;
                    }

                    // Importer les catégories
                    customPositiveActions = config.customPositiveActions || [];
                    customNegativeActions = config.customNegativeActions || [];

                    // Importer les règles métier
                    businessRules = config.businessRules || [];
                    if (businessRules.length > 0) {
                        nextRuleId = Math.max(...businessRules.map(r => parseInt(r.id.replace('rule_', '')))) + 1;
                    }

                    // Importer la config de source de données
                    if (config.dataSourceConfig) {
                        if (config.dataSourceConfig.googleSheetUrl) {
                            document.getElementById('googleSheetUrl').value = config.dataSourceConfig.googleSheetUrl;
                            dataSourceConfig.googleSheetUrl = config.dataSourceConfig.googleSheetUrl;
                        }
                    }

                    // Mettre à jour l'affichage si des données sont déjà chargées
                    if (basketballData.length > 0) {
                        const allActions = [...new Set(basketballData.map(d => d.Action))].sort();
                        updateCategoryConfiguration(allActions);
                        updateRulesList();
                        updateRulesToggleBanner();
                        detectRuleMatches();
                        updateDashboard();
                    }

                    alert(`✅ Configuration importée avec succès !\n\n` +
                          `- ${customPositiveActions.length} actions positives\n` +
                          `- ${customNegativeActions.length} actions négatives\n` +
                          `- ${businessRules.length} règles métier`);

                } catch (error) {
                    console.error('Erreur import:', error);
                    alert('❌ Erreur lors de l\'import de la configuration');
                }
            };

            reader.readAsText(file);
            event.target.value = '';
        }

        function handleDataSourceChange() {
            const sourceType = document.getElementById('dataSourceSelect').value;
            const localConnection = document.getElementById('localConnection');
            const googleDriveConnection = document.getElementById('googleDriveConnection');

            // Masquer toutes les options
            localConnection.classList.remove('visible');
            googleDriveConnection.classList.remove('visible');

            // Afficher l'option sélectionnée
            if (sourceType === 'local') {
                localConnection.classList.add('visible');
                dataSourceConfig.type = 'local';
            } else if (sourceType === 'googleDrive') {
                googleDriveConnection.classList.add('visible');
                dataSourceConfig.type = 'googleDrive';
            } else {
                dataSourceConfig.type = 'none';
            }

            // Sauvegarder la config
            saveDataSourceConfig();
        }

        function handleLocalFileSelection(event) {
            const file = event.target.files[0];
            if (!file) return;

            document.getElementById('localFilePath').value = file.name;

            // Lire et stocker le contenu du fichier
            const reader = new FileReader();
            reader.onload = function(e) {
                dataSourceConfig.localFilePath = file.name;
                dataSourceConfig.localFileData = e.target.result;
                saveDataSourceConfig();

                // Charger immédiatement les données
                parseCSVData(e.target.result);
                alert('✅ Fichier local enregistré comme source par défaut !');
            };
            reader.readAsText(file);
        }

        function saveGoogleSheetUrl() {
            const url = document.getElementById('googleSheetUrl').value.trim();
            if (!url) {
                alert('⚠️ Veuillez saisir une URL valide');
                return;
            }

            dataSourceConfig.googleSheetUrl = url;
            saveDataSourceConfig();

            // Tenter de charger les données
            loadFromGoogleSheet();
        }

        function testGoogleSheetConnection() {
            const url = document.getElementById('googleSheetUrl').value.trim();
            if (!url) {
                alert('⚠️ Veuillez saisir une URL pour tester');
                return;
            }

            // Sauvegarder temporairement l'URL actuelle
            const previousUrl = dataSourceConfig.googleSheetUrl;
            dataSourceConfig.googleSheetUrl = url;

            console.log('🧪 Test de connexion Google Sheet...');

            // Tester le chargement sans sauvegarder
            loadFromGoogleSheet();

            // Restaurer l'URL précédente si le test échoue
            setTimeout(() => {
                if (!basketballData || basketballData.length === 0) {
                    dataSourceConfig.googleSheetUrl = previousUrl;
                }
            }, 3000);
        }

        function saveDataSourceConfig() {
            try {
                const configToSave = {
                    type: dataSourceConfig.type,
                    localFilePath: dataSourceConfig.localFilePath,
                    localFileData: dataSourceConfig.localFileData,
                    googleSheetUrl: dataSourceConfig.googleSheetUrl
                };
                localStorage.setItem('dataSourceConfig', JSON.stringify(configToSave));
            } catch (e) {
                console.warn('Erreur sauvegarde config:', e);
            }
        }

        function loadDataSourceConfig() {
            try {
                const saved = localStorage.getItem('dataSourceConfig');
                if (saved) {
                    const config = JSON.parse(saved);
                    dataSourceConfig = config;

                    // Restaurer l'UI
                    document.getElementById('dataSourceSelect').value = config.type || 'none';

                    if (config.type === 'local' && config.localFilePath) {
                        document.getElementById('localFilePath').value = config.localFilePath;
                        handleDataSourceChange();

                        // Auto-charger si données disponibles
                        if (config.localFileData) {
                            parseCSVData(config.localFileData);
                        }
                    } else if (config.type === 'googleDrive' && config.googleSheetUrl) {
                        document.getElementById('googleSheetUrl').value = config.googleSheetUrl;
                        handleDataSourceChange();
                        loadFromGoogleSheet();
                    }
                }
            } catch (e) {
                console.warn('Erreur chargement config:', e);
            }
        }

        function loadFromGoogleSheet() {
            const url = dataSourceConfig.googleSheetUrl;
            if (!url) return;

            // Extraire l'ID du document Google Sheets
            let csvUrl = url;
            let sheetId = null;

            // Essayer d'extraire l'ID du document
            const idMatch = url.match(/\/d\/([a-zA-Z0-9-_]+)/);
            const eIdMatch = url.match(/\/d\/e\/([a-zA-Z0-9-_]+)/);

            if (eIdMatch) {
                // Format publication : /d/e/DOCUMENT_ID/pub
                sheetId = eIdMatch[1];
                csvUrl = `https://docs.google.com/spreadsheets/d/e/${sheetId}/pub?output=csv`;
                console.log('📄 Format publication détecté, ID:', sheetId);
            } else if (idMatch) {
                // Format édition : /d/DOCUMENT_ID/edit
                sheetId = idMatch[1];
                csvUrl = `https://docs.google.com/spreadsheets/d/${sheetId}/export?format=csv`;
                console.log('📄 Format édition détecté, ID:', sheetId);
            } else if (url.includes('output=csv') || url.includes('export?format=csv')) {
                // URL déjà au bon format
                csvUrl = url;
                console.log('📄 URL CSV détectée');
            }

            console.log('🔗 Chargement depuis:', csvUrl);

            // Tentative 1 : Fetch direct
            fetch(csvUrl, { mode: 'cors' })
                .then(response => {
                    console.log('📥 Réponse reçue:', response.status, response.statusText);
                    if (!response.ok) {
                        throw new Error(`Erreur HTTP ${response.status}`);
                    }
                    return response.text();
                })
                .then(csvData => {
                    console.log('✅ Données CSV reçues:', csvData.substring(0, 200) + '...');
                    parseCSVData(csvData);
                    alert('✅ Données chargées depuis Google Drive !');
                })
                .catch(error => {
                    console.error('❌ Erreur fetch direct:', error);

                    // Tentative 2 : Utiliser un proxy CORS
                    const proxyUrl = `https://api.allorigins.win/raw?url=${encodeURIComponent(csvUrl)}`;
                    console.log('🔄 Tentative avec proxy CORS:', proxyUrl);

                    fetch(proxyUrl)
                        .then(response => {
                            if (!response.ok) {
                                throw new Error('Erreur proxy CORS');
                            }
                            return response.text();
                        })
                        .then(csvData => {
                            console.log('✅ Données CSV reçues via proxy');
                            parseCSVData(csvData);
                            alert('✅ Données chargées depuis Google Drive (via proxy) !');
                        })
                        .catch(proxyError => {
                            console.error('❌ Erreur proxy CORS:', proxyError);
                            alert('❌ Impossible de charger le Google Sheet.\n\n' +
                                  'Erreurs rencontrées:\n' +
                                  `1. Fetch direct: ${error.message}\n` +
                                  `2. Proxy CORS: ${proxyError.message}\n\n` +
                                  'Solutions:\n' +
                                  '• Vérifiez que le fichier est bien publié\n' +
                                  '• Essayez d\'utiliser l\'import manuel (fichier local)');
                        });
                });
        }

        // ============================================
        // GESTION DES RÈGLES MÉTIER
        // ============================================

        let tempRuleSequence = [];

		function toggleBusinessRulesSection() {
			const content = document.getElementById('businessRulesContent');
			const icon = document.getElementById('toggleIcon');

			businessRulesSectionCollapsed = !businessRulesSectionCollapsed;

			if (businessRulesSectionCollapsed) {
				content.style.maxHeight = content.scrollHeight + 'px';
				setTimeout(() => {
					content.style.maxHeight = '0px';
					content.style.opacity = '0';
				}, 10);
				setTimeout(() => {
					content.style.display = 'none';
				}, 300);
				icon.textContent = '📈';
			} else {
				content.style.display = 'block';
				content.style.maxHeight = '0px';
				content.style.opacity = '0';
				setTimeout(() => {
					content.style.maxHeight = content.scrollHeight + 'px';
					content.style.opacity = '1';
				}, 10);
				setTimeout(() => {
					content.style.maxHeight = 'none';
				}, 300);
				icon.textContent = '📉';
			}
		}

		function initializeRuleActionsSelector() {
			if (basketballData.length === 0) return;

			const allActions = [...new Set(basketballData.map(d => d.Action))].sort();
			const container = document.getElementById('ruleActionsSelector');

			container.innerHTML = '<p style="margin: 0 0 10px 0; color: #34495e; font-weight: 600;">Cliquez pour ajouter des actions dans l\'ordre :</p>';

			const actionsGrid = document.createElement('div');
			actionsGrid.style.cssText = 'display: flex; flex-wrap: wrap; gap: 8px;';

			allActions.forEach(action => {
				const btn = document.createElement('button');
				btn.textContent = action;
				btn.className = 'rule-action-btn';
				btn.style.cssText = `
					background: white;
					border: 2px solid #3498db;
					color: #3498db;
					padding: 8px 15px;
					border-radius: 5px;
					cursor: pointer;
					font-size: 0.9rem;
					transition: all 0.2s ease;
				`;

				btn.onmouseover = () => {
					btn.style.background = '#3498db';
					btn.style.color = 'white';
				};
				btn.onmouseout = () => {
					btn.style.background = 'white';
					btn.style.color = '#3498db';
				};

				btn.onclick = () => addActionToSequence(action);
				actionsGrid.appendChild(btn);
			});

			container.appendChild(actionsGrid);
		}

		function addActionToSequence(action) {
			tempRuleSequence.push(action);
			updateSequencePreview();
		}

		function updateSequencePreview() {
			const preview = document.getElementById('sequencePreview');

			if (tempRuleSequence.length === 0) {
				preview.innerHTML = 'vide';
				return;
			}

			preview.innerHTML = tempRuleSequence.map((action, idx) =>
				`<span style="background: #3498db; color: white; padding: 4px 10px; border-radius: 5px; font-size: 0.85rem; display: inline-flex; align-items: center; gap: 5px;">
					${idx + 1}. ${action}
					<button onclick="removeActionFromSequence(${idx})" style="background: rgba(255,255,255,0.3); border: none; border-radius: 3px; cursor: pointer; padding: 2px 6px; color: white; font-weight: bold;">×</button>
				</span>`
			).join(' → ');
		}

		function removeActionFromSequence(index) {
			tempRuleSequence.splice(index, 1);
			updateSequencePreview();
		}

		function createBusinessRule() {
			const name = document.getElementById('ruleNameInput').value.trim();
			const isPositive = document.querySelector('input[name="ruleType"]:checked').value === 'positive';

			if (!name) {
				alert('⚠️ Veuillez donner un nom à la règle');
				return;
			}

			if (tempRuleSequence.length < 2) {
				alert('⚠️ Une règle doit contenir au moins 2 actions');
				return;
			}

			const newRule = {
				id: `rule_${nextRuleId++}`,
				name: name,
				actions: [...tempRuleSequence],
				isPositive: isPositive,
				isActive: true,
				color: isPositive ? '#2c5aa0' : '#dc2626'
			};

			businessRules.push(newRule);
			console.log('✅ Règle créée:', newRule);

			// Réinitialiser le formulaire
			document.getElementById('ruleNameInput').value = '';
			tempRuleSequence = [];
			updateSequencePreview();

			// Ouvrir la section des règles métier si elle est réduite
			if (businessRulesSectionCollapsed) {
				toggleBusinessRulesSection();
			}

			console.log('📊 Données disponibles:', filteredData.length, 'actions');
			detectRuleMatches();
			console.log('🎯 Détections trouvées:', ruleMatches.length);
			updateRulesList();
			updateRulesToggleBanner();
			applyFilters();

			alert(`✅ Règle "${name}" créée avec succès !\n${ruleMatches.filter(m => m.ruleId === newRule.id).length} séquences détectées.`);
		}

		function updateRulesList() {
			const container = document.getElementById('rulesListContainer');

			if (businessRules.length === 0) {
				container.innerHTML = '<p style="color: #7f8c8d; font-style: italic; text-align: center; padding: 20px;">Aucune règle créée pour le moment</p>';
				return;
			}

			console.log('📋 Mise à jour de la liste des règles:', businessRules.length, 'règle(s)');

			container.innerHTML = businessRules.map(rule => {
				const detectionCount = ruleMatches.filter(m => m.ruleId === rule.id).length;
				console.log(`  - Règle "${rule.name}": ${detectionCount} détections`);

				return `
				<div style="background: ${rule.isActive ? 'linear-gradient(135deg, #f8f9fa, #e9ecef)' : '#f1f3f5'};
							border-left: 5px solid ${rule.color};
							padding: 15px;
							margin-bottom: 15px;
							opacity: ${rule.isActive ? '1' : '0.6'};">
					<div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
						<div>
							<h4 style="margin: 0 0 5px 0; color: #2c3e50; font-size: 1.1rem;">
								${rule.isActive ? '✅' : '⭕'} ${rule.name}
							</h4>
							<span style="background: ${rule.color}; color: white; padding: 3px 10px; border-radius: 5px; font-size: 0.8rem; font-weight: 600;">
								${rule.isPositive ? 'POSITIVE' : 'NÉGATIVE'}
							</span>
						</div>
						<div style="display: flex; gap: 8px;">
							<button onclick="toggleRule('${rule.id}')"
									style="background: ${rule.isActive ? '#f39c12' : '#2ecc71'}; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; font-size: 0.85rem;">
								${rule.isActive ? '⏸️ Désactiver' : '▶️ Activer'}
							</button>
							<button onclick="deleteRule('${rule.id}')"
									style="background: #e74c3c; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; font-size: 0.85rem;">
								🗑️ Supprimer
							</button>
						</div>
					</div>
					<div style="background: white; padding: 10px; border-radius: 5px; font-family: monospace; font-size: 0.9rem;">
						<strong>Séquence :</strong> ${rule.actions.map((a, i) => `<span style="color: ${rule.color};">${i + 1}. ${a}</span>`).join(' → ')}
					</div>
					<div style="margin-top: 10px; color: #7f8c8d; font-size: 0.85rem;">
						${rule.actions.length} actions • Détections : <span style="font-weight: ${detectionCount > 0 ? 'bold' : 'normal'}; color: ${detectionCount > 0 ? rule.color : '#7f8c8d'};">${detectionCount}</span>
					</div>
				</div>
				`;
			}).join('');
		}

		function updateRulesToggleBanner() {
			const container = document.getElementById('rulesToggleContainer');
			const toggleBtn = document.getElementById('toggleAllRulesBtn');

			if (businessRules.length === 0) {
				container.innerHTML = '<span style="color: #7f8c8d; font-style: italic;">Aucune règle créée</span>';
				toggleBtn.disabled = true;
				toggleBtn.style.opacity = '0.5';
				return;
			}

			toggleBtn.disabled = false;
			toggleBtn.style.opacity = '1';

			const allActive = businessRules.every(r => r.isActive);
			toggleBtn.textContent = allActive ? '⭕ Tout désactiver' : '✅ Tout activer';

			container.innerHTML = businessRules.map(rule => `
				<button onclick="toggleRule('${rule.id}')"
						style="background: ${rule.isActive ? rule.color : '#95a5a6'};
							   color: white;
							   border: none;
							   padding: 6px 12px;
							   border-radius: 5px;
							   cursor: pointer;
							   font-size: 0.85rem;
							   transition: all 0.2s ease;">
					${rule.isActive ? '✅' : '⭕'} ${rule.name}
				</button>
			`).join('');
		}

		function toggleRule(ruleId) {
			const rule = businessRules.find(r => r.id === ruleId);
			if (rule) {
				rule.isActive = !rule.isActive;
				detectRuleMatches();
				updateRulesList();
				updateRulesToggleBanner();
				applyFilters();
			}
		}

		function toggleAllRules() {
			const allActive = businessRules.every(r => r.isActive);
			businessRules.forEach(r => r.isActive = !allActive);
			detectRuleMatches();
			updateRulesList();
			updateRulesToggleBanner();
			applyFilters();
		}

		function deleteRule(ruleId) {
			if (!confirm('Êtes-vous sûr de vouloir supprimer cette règle ?')) return;

			businessRules = businessRules.filter(r => r.id !== ruleId);
			ruleMatches = ruleMatches.filter(m => m.ruleId !== ruleId);

			updateRulesList();
			updateRulesToggleBanner();
			applyFilters();
		}

		function detectRuleMatches() {
			ruleMatches = [];

			if (filteredData.length === 0 || businessRules.length === 0) {
				console.log('⚠️ Pas de détection: filteredData =', filteredData.length, ', businessRules =', businessRules.length);
				return;
			}

			const sortedData = [...filteredData].sort((a, b) =>
				parseInt(a.Position || 0) - parseInt(b.Position || 0)
			);

			const dataByMatch = {};
			sortedData.forEach(d => {
				const matchKey = `${d.Date}|${d.Adversaire}`;
				if (!dataByMatch[matchKey]) {
					dataByMatch[matchKey] = [];
				}
				dataByMatch[matchKey].push(d);
			});

			console.log(`🔍 Recherche dans ${Object.keys(dataByMatch).length} match(s) avec ${businessRules.filter(r => r.isActive).length} règle(s) active(s)`);

			Object.entries(dataByMatch).forEach(([matchKey, matchData]) => {
				const [date, adversaire] = matchKey.split('|');

				businessRules.filter(r => r.isActive).forEach(rule => {
					const ruleLength = rule.actions.length;

					for (let i = 0; i <= matchData.length - ruleLength; i++) {
						const sequence = matchData.slice(i, i + ruleLength);

						const matches = sequence.every((item, idx) =>
							item.Action === rule.actions[idx]
						);

						if (matches) {
							console.log(`✅ Séquence trouvée pour règle "${rule.name}":`, sequence.map(s => s.Action));
							ruleMatches.push({
								ruleId: rule.id,
								ruleName: rule.name,
								isPositive: rule.isPositive,
								players: [...new Set(sequence.map(s => s.Joueur))],
								startPosition: parseInt(sequence[0].Position || 0),
								endPosition: parseInt(sequence[ruleLength - 1].Position || 0),
								quarter: sequence[0]['Période'],
								date: date,
								adversaire: adversaire,
								sequence: sequence.map(s => ({
									action: s.Action,
									player: s.Joueur,
									time: s.Temps
								}))
							});
						}
					}
				});
			});

			console.log(`🎯 ${ruleMatches.length} séquences détectées au total`);
		}

        // ============================================
        // INITIALISATION
        // ============================================

        window.onload = function() {
            initializeEmptyDashboard();
            loadDataSourceConfig();
        };

        // Gestion des fichiers
        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (file && file.type === 'text/csv') {
                const reader = new FileReader();
                reader.onload = function(e) {
                    parseCSVData(e.target.result);
                };
                reader.readAsText(file);
            }
        }

        function handleFileDrop(event) {
            event.preventDefault();
            event.currentTarget.classList.remove('dragover');
            const file = event.dataTransfer.files[0];
            if (file && file.type === 'text/csv') {
                const reader = new FileReader();
                reader.onload = function(e) {
                    parseCSVData(e.target.result);
                };
                reader.readAsText(file);
            }
        }

        function handleDragOver(event) {
            event.preventDefault();
            event.currentTarget.classList.add('dragover');
        }

        function handleDragLeave(event) {
            event.currentTarget.classList.remove('dragover');
        }

        function initializeEmptyDashboard() {
            basketballData = [];
            filteredData = [];

            document.getElementById('dateFilter').innerHTML = '<option value="">Toutes les dates</option>';
            document.getElementById('adversaireFilter').innerHTML = '<option value="">Tous les adversaires</option>';
            document.getElementById('quartFilter').innerHTML = '<option value="">Toutes les périodes</option>';
            document.getElementById('playersCheckboxes').innerHTML = '<p style="color: #7f8c8d; font-style: italic;">Aucun joueur disponible</p>';
            document.getElementById('actionsCheckboxes').innerHTML = '<p style="color: #7f8c8d; font-style: italic;">Aucune action disponible</p>';

            updateStats();
            initializeEmptyCharts();

            document.getElementById('positiveActionsConfig').innerHTML = '<p style="color: #7f8c8d; font-style: italic;">Aucune action disponible</p>';
            document.getElementById('negativeActionsConfig').innerHTML = '<p style="color: #7f8c8d; font-style: italic;">Aucune action disponible</p>';

            customPositiveActions = [];
            customNegativeActions = [];
            selectedStats = [];
            document.getElementById('statsFilterContainer').innerHTML = '';
            document.getElementById('playersGrid').innerHTML = '<div class="no-data">Importez un fichier CSV pour commencer l\'analyse</div>';
        }

        function parseCSVData(csvText) {
            const lines = csvText.trim().split('\n');
            const headers = lines[0].split(',').map(h => h.trim());

            basketballData = lines.slice(1).map((line, index) => {
                const values = line.split(',').map(v => v.trim());
                const obj = {};
                headers.forEach((header, idx) => {
                    obj[header] = values[idx];
                });
                // Ajouter Position seulement si elle n'existe pas déjà dans le CSV
                if (!obj.Position && obj.Position !== 0) {
                    obj.Position = index;
                }
                return obj;
            });

            filteredData = [...basketballData];
            initializeFilters();
            updateDashboard();
        }

        function initializeFilters() {
            const dates = [...new Set(basketballData.map(d => d.Date))].sort();
            const dateSelect = document.getElementById('dateFilter');
            dateSelect.innerHTML = '<option value="">Toutes les dates</option>';
            dates.forEach(date => {
                dateSelect.innerHTML += `<option value="${date}">${new Date(date).toLocaleDateString('fr-FR')}</option>`;
            });

            const adversaires = [...new Set(basketballData.map(d => d.Adversaire))].sort();
            const adversaireSelect = document.getElementById('adversaireFilter');
            adversaireSelect.innerHTML = '<option value="">Tous les adversaires</option>';
            adversaires.forEach(adv => {
                adversaireSelect.innerHTML += `<option value="${adv}">${adv}</option>`;
            });

            const quarters = [...new Set(basketballData.map(d => d['Période']))].sort();
            const quartSelect = document.getElementById('quartFilter');
            quartSelect.innerHTML = '<option value="">Toutes les périodes</option>';
            quarters.forEach(q => {
                quartSelect.innerHTML += `<option value="${q}">${q}</option>`;
            });

            const players = [...new Set(basketballData.map(d => d.Joueur))].sort();
            const playersContainer = document.getElementById('playersCheckboxes');
            playersContainer.innerHTML = '';
            players.forEach(player => {
                const div = document.createElement('div');
                div.className = 'checkbox-item active';
                div.innerHTML = `<input type="checkbox" id="player-${player}" checked onchange="applyFilters()"> ${player}`;
                div.onclick = function() {
                    const checkbox = div.querySelector('input');
                    checkbox.checked = !checkbox.checked;
                    div.classList.toggle('active', checkbox.checked);
                    applyFilters();
                };
                playersContainer.appendChild(div);
            });

            const actions = [...new Set(basketballData.map(d => d.Action))].sort();
            const actionsContainer = document.getElementById('actionsCheckboxes');
            actionsContainer.innerHTML = '';
            actions.forEach(action => {
                const div = document.createElement('div');
                div.className = 'checkbox-item active';
                div.innerHTML = `<input type="checkbox" id="action-${action}" checked onchange="applyFilters()"> ${action}`;
                div.onclick = function() {
                    const checkbox = div.querySelector('input');
                    checkbox.checked = !checkbox.checked;
                    div.classList.toggle('active', checkbox.checked);
                    applyFilters();
                };
                actionsContainer.appendChild(div);
            });

            initializeCategoryConfiguration();
			initializeRuleActionsSelector();
            populateStatsFilters();
        }

        function initializeCategoryConfiguration() {
            if (basketballData.length === 0) return;

            const allActions = [...new Set(basketballData.map(d => d.Action))].sort();
            updateCategoryConfiguration(allActions);
        }

        function updateCategoryConfiguration(allActions) {
            const positiveContainer = document.getElementById('positiveActionsConfig');
            const negativeContainer = document.getElementById('negativeActionsConfig');

            positiveContainer.innerHTML = '';
            negativeContainer.innerHTML = '';

            const existingUncategorized = document.querySelector('.uncategorized-section');
            if (existingUncategorized) {
                existingUncategorized.remove();
            }

            if (customPositiveActions.length === 0 && customNegativeActions.length === 0) {
                customPositiveActions = ['1 Point','2 Points', '3 Points', 'Passes décisive', 'Rebond', 'Interceptions']
                    .filter(action => allActions.includes(action));
                customNegativeActions = ['Fautes', 'Perte de balle']
                    .filter(action => allActions.includes(action));
            }

            customPositiveActions.forEach(action => {
                const div = createCategoryItem(action, 'positive');
                positiveContainer.appendChild(div);
            });

            customNegativeActions.forEach(action => {
                const div = createCategoryItem(action, 'negative');
                negativeContainer.appendChild(div);
            });

            const uncategorizedActions = allActions.filter(action =>
                !customPositiveActions.includes(action) && !customNegativeActions.includes(action)
            );

            const uncategorizedSection = document.createElement('div');
            uncategorizedSection.className = 'uncategorized-section';

            const uncategorizedTitle = document.createElement('p');
            uncategorizedTitle.style.cssText = 'color: #7f8c8d; margin-bottom: 15px; font-weight: 600; font-size: 1.1rem;';
            uncategorizedTitle.textContent = 'Actions non catégorisées :';
            uncategorizedSection.appendChild(uncategorizedTitle);

            const uncategorizedContainer = document.createElement('div');
            uncategorizedContainer.className = 'uncategorized-actions';
            uncategorizedContainer.style.cssText = `
                min-height: 60px;
                padding: 15px;
                background: rgba(248, 249, 250, 0.8);
                border: 2px dashed #bdc3c7;
                border-radius: 8px;
                display: flex;
                flex-wrap: wrap;
                gap: 10px;
                align-items: flex-start;
                width: 100%;
            `;

            if (uncategorizedActions.length > 0) {
                uncategorizedActions.forEach(action => {
                    const div = createCategoryItem(action, 'uncategorized');
                    uncategorizedContainer.appendChild(div);
                });
            } else {
                const messageDiv = document.createElement('div');
                messageDiv.style.cssText = `
                    width: 100%;
                    text-align: center;
                    color: #27ae60;
                    font-style: italic;
                    font-weight: 500;
                    padding: 20px;
                `;
                messageDiv.textContent = 'Toutes les actions sont catégorisées';
                uncategorizedContainer.appendChild(messageDiv);
            }

            uncategorizedSection.appendChild(uncategorizedContainer);

            const configSection = positiveContainer.closest('.filters-section');
            configSection.appendChild(uncategorizedSection);

            makeDroppable(positiveContainer, 'positive');
            makeDroppable(negativeContainer, 'negative');
            makeDroppable(uncategorizedContainer, 'uncategorized');
        }

        function createCategoryItem(action, category) {
            const div = document.createElement('div');
            div.className = `category-config-item ${category}`;
            div.draggable = true;
            div.dataset.action = action;

            if (category === 'uncategorized') {
                div.style.cssText += `
                    background: #ffffff;
                    border: 1px solid #dee2e6;
                    color: #6c757d;
                `;
            }

            div.innerHTML = `
                <span>${action}</span>
                ${category !== 'uncategorized' ? '<button class="remove-from-category" onclick="removeFromCategory(this)">×</button>' : ''}
            `;

            div.addEventListener('dragstart', function(e) {
                e.dataTransfer.setData('text/plain', action);
                div.classList.add('dragging');
            });

            div.addEventListener('dragend', function(e) {
                div.classList.remove('dragging');
            });

            return div;
        }

        function makeDroppable(container, category) {
            container.addEventListener('dragover', function(e) {
                e.preventDefault();
                if (category !== 'uncategorized') {
                    container.classList.add('drag-over');
                }
            });

            container.addEventListener('dragleave', function(e) {
                if (category !== 'uncategorized') {
                    container.classList.remove('drag-over');
                }
            });

            container.addEventListener('drop', function(e) {
                e.preventDefault();
                const action = e.dataTransfer.getData('text/plain');
                if (category !== 'uncategorized') {
                    addToCategory(action, category);
                    container.classList.remove('drag-over');
                }
            });
        }

        function addToCategory(action, category) {
            customPositiveActions = customPositiveActions.filter(a => a !== action);
            customNegativeActions = customNegativeActions.filter(a => a !== action);

            if (category === 'positive') {
                customPositiveActions.push(action);
            } else if (category === 'negative') {
                customNegativeActions.push(action);
            }

            const allActions = [...new Set(basketballData.map(d => d.Action))].sort();
            updateCategoryConfiguration(allActions);
            updateDashboard();
        }

        function removeFromCategory(button) {
            const action = button.parentElement.dataset.action;
            customPositiveActions = customPositiveActions.filter(a => a !== action);
            customNegativeActions = customNegativeActions.filter(a => a !== action);

            const allActions = [...new Set(basketballData.map(d => d.Action))].sort();
            updateCategoryConfiguration(allActions);
            updateDashboard();
        }

        function resetCategorization() {
            customPositiveActions = [];
            customNegativeActions = [];

            if (basketballData.length > 0) {
                const allActions = [...new Set(basketballData.map(d => d.Action))].sort();
                updateCategoryConfiguration(allActions);
                updateDashboard();
            }
        }

        function applyFilters() {
            const dateFilter = document.getElementById('dateFilter').value;
            const adversaireFilter = document.getElementById('adversaireFilter').value;
            const quartFilter = document.getElementById('quartFilter').value;

            const selectedPlayers = Array.from(document.querySelectorAll('#playersCheckboxes input:checked'))
                .map(checkbox => checkbox.id.replace('player-', ''));

            const selectedActions = Array.from(document.querySelectorAll('#actionsCheckboxes input:checked'))
                .map(checkbox => checkbox.id.replace('action-', ''));

            filteredData = basketballData.filter(d => {
                return (!dateFilter || d.Date === dateFilter) &&
                       (!adversaireFilter || d.Adversaire === adversaireFilter) &&
                       (!quartFilter || d['Période'] === quartFilter) &&
                       selectedPlayers.includes(d.Joueur) &&
                       selectedActions.includes(d.Action);
            });

            detectRuleMatches();
            updateDashboard();
        }

        function resetAllFilters() {
            document.getElementById('dateFilter').value = '';
            document.getElementById('adversaireFilter').value = '';
            document.getElementById('quartFilter').value = '';

            document.querySelectorAll('#playersCheckboxes .checkbox-item').forEach(item => {
                item.querySelector('input').checked = true;
                item.classList.add('active');
            });

            document.querySelectorAll('#actionsCheckboxes .checkbox-item').forEach(item => {
                item.querySelector('input').checked = true;
                item.classList.add('active');
            });

            filteredData = [...basketballData];
            detectRuleMatches();
            updateDashboard();
        }

        function categorizeActions() {
            const positiveActions = customPositiveActions.length > 0 ? customPositiveActions :
                ['1 Point', '2 Points', '3 Points', 'Passes décisive', 'Rebond', 'Interceptions'];
            const negativeActions = customNegativeActions.length > 0 ? customNegativeActions :
                ['Fautes', 'Perte de balle'];

            return { positiveActions, negativeActions };
        }

        function updateStats() {
            const { positiveActions, negativeActions } = categorizeActions();

            const totalActions = filteredData.length;
            const totalPoints = filteredData.filter(d =>
                d.Action === '2 Points' || d.Action === '3 Points' || d.Action === '1 Point'
            ).reduce((sum, d) => sum + parseInt(d.Action.split(' ')[0]), 0);

            const positiveCount = filteredData.filter(d => positiveActions.includes(d.Action)).length;
            const negativeCount = filteredData.filter(d => negativeActions.includes(d.Action)).length;

            const activePlayers = new Set(filteredData.map(d => d.Joueur)).size;
            const matches = new Set(filteredData.map(d => `${d.Date}-${d.Adversaire}`)).size;

            document.getElementById('totalActions').textContent = totalActions;
            document.getElementById('totalPoints').textContent = totalPoints;
            document.getElementById('positiveActions').textContent = positiveCount;
            document.getElementById('negativeActions').textContent = negativeCount;
            document.getElementById('activePlayersCount').textContent = activePlayers;
            document.getElementById('matchesCount').textContent = matches;
        }

        function initializeEmptyCharts() {
            const chartIds = [
                'playersChart', 'quartersChart', 'actionsChart', 'timelineChart',
                'performanceRankingChart', 'balanceChart', 'actionsByQuarterChart', 'actionsByMatchChart'
            ];

            chartIds.forEach(chartId => {
                const ctx = document.getElementById(chartId).getContext('2d');
                if (charts[chartId]) charts[chartId].destroy();

                charts[chartId] = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: [],
                        datasets: [{
                            label: 'Aucune donnée',
                            data: [],
                            backgroundColor: '#e0e0e0'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false }
                        }
                    }
                });
            });
        }

        function updateDashboard() {
            updateStats();
            updatePlayersChart();
            updateQuartersChart();
            updateActionsChart();
            updateTimelineChart();
            updatePerformanceRankingChart();
            updateBalanceChart();
            updateActionsByQuarterChart();
            updateActionsByMatchChart();
            updatePlayersGrid();
        }

        // Graphiques (simplifiés pour la taille du fichier)
        function updatePlayersChart() {
            const { positiveActions, negativeActions } = categorizeActions();
            const playerStats = {};

            const players = [...new Set(filteredData.map(d => d.Joueur))];
            players.forEach(player => {
                playerStats[player] = { positive: 0, negative: 0 };
            });

            filteredData.forEach(d => {
                if (positiveActions.includes(d.Action)) {
                    playerStats[d.Joueur].positive++;
                } else if (negativeActions.includes(d.Action)) {
                    playerStats[d.Joueur].negative++;
                }
            });

            const ctx = document.getElementById('playersChart').getContext('2d');
            if (charts.playersChart) charts.playersChart.destroy();

            charts.playersChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: players,
                    datasets: [
                        {
                            label: 'Actions Positives',
                            data: players.map(p => playerStats[p].positive),
                            backgroundColor: '#2c5aa0'
                        },
                        {
                            label: 'Actions Négatives',
                            data: players.map(p => playerStats[p].negative),
                            backgroundColor: '#dc2626'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'top' }
                    },
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });
        }

        function updateQuartersChart() {
            const { positiveActions, negativeActions } = categorizeActions();
            const quarters = [...new Set(filteredData.map(d => d['Période']))].sort();
            const quarterStats = {};

            quarters.forEach(q => {
                quarterStats[q] = { positive: 0, negative: 0 };
            });

            filteredData.forEach(d => {
                if (positiveActions.includes(d.Action)) {
                    quarterStats[d['Période']].positive++;
                } else if (negativeActions.includes(d.Action)) {
                    quarterStats[d['Période']].negative++;
                }
            });

            const ctx = document.getElementById('quartersChart').getContext('2d');
            if (charts.quartersChart) charts.quartersChart.destroy();

            charts.quartersChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: quarters,
                    datasets: [
                        {
                            label: 'Actions Positives',
                            data: quarters.map(q => quarterStats[q].positive),
                            backgroundColor: '#2c5aa0'
                        },
                        {
                            label: 'Actions Négatives',
                            data: quarters.map(q => quarterStats[q].negative),
                            backgroundColor: '#dc2626'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'top' }
                    },
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });
        }

        function updateActionsChart() {
            const actionCounts = {};
            filteredData.forEach(d => {
                actionCounts[d.Action] = (actionCounts[d.Action] || 0) + 1;
            });

            const ctx = document.getElementById('actionsChart').getContext('2d');
            if (charts.actionsChart) charts.actionsChart.destroy();

            charts.actionsChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(actionCounts),
                    datasets: [{
                        data: Object.values(actionCounts),
                        backgroundColor: [
                            '#3498db', '#2ecc71', '#e74c3c', '#f39c12', '#9b59b6',
                            '#1abc9c', '#34495e', '#e67e22'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'right' }
                    }
                }
            });
        }

        function updateTimelineChart() {
            const { positiveActions, negativeActions } = categorizeActions();
            const quarters = [...new Set(filteredData.map(d => d['Période']))].sort();
            const quarterStats = {};

            quarters.forEach(q => {
                quarterStats[q] = { positive: 0, negative: 0 };
            });

            filteredData.forEach(d => {
                if (positiveActions.includes(d.Action)) {
                    quarterStats[d['Période']].positive++;
                } else if (negativeActions.includes(d.Action)) {
                    quarterStats[d['Période']].negative++;
                }
            });

            const ctx = document.getElementById('timelineChart').getContext('2d');
            if (charts.timelineChart) charts.timelineChart.destroy();

            charts.timelineChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: quarters,
                    datasets: [
                        {
                            label: 'Actions Positives',
                            data: quarters.map(q => quarterStats[q].positive),
                            borderColor: '#2c5aa0',
                            backgroundColor: 'rgba(44, 90, 160, 0.1)',
                            fill: true
                        },
                        {
                            label: 'Actions Négatives',
                            data: quarters.map(q => quarterStats[q].negative),
                            borderColor: '#dc2626',
                            backgroundColor: 'rgba(220, 38, 38, 0.1)',
                            fill: true
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'top' }
                    },
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });
        }

        function updatePerformanceRankingChart() {
            const { positiveActions, negativeActions } = categorizeActions();
            const playerStats = {};

            const players = [...new Set(filteredData.map(d => d.Joueur))];
            players.forEach(player => {
                playerStats[player] = { positive: 0, negative: 0, performance: 0 };
            });

            filteredData.forEach(d => {
                if (positiveActions.includes(d.Action)) {
                    playerStats[d.Joueur].positive++;
                } else if (negativeActions.includes(d.Action)) {
                    playerStats[d.Joueur].negative++;
                }
            });

            Object.keys(playerStats).forEach(player => {
                playerStats[player].performance = playerStats[player].positive - playerStats[player].negative;
            });

            const sortedPlayers = Object.entries(playerStats)
                .sort((a, b) => b[1].performance - a[1].performance);

            const ctx = document.getElementById('performanceRankingChart').getContext('2d');
            if (charts.performanceRankingChart) charts.performanceRankingChart.destroy();

            const performanceValues = sortedPlayers.map(([, stats]) => stats.performance);
            const maxValue = Math.max(...performanceValues.map(Math.abs), 5);
            const scaledMax = Math.ceil(maxValue * 1.1);

            const backgroundColors = performanceValues.map(value => {
                if (value > 0) return '#166534';
                if (value === 0) return '#000000';
                return '#dc2626';
            });

            const borderColors = performanceValues.map(value => {
                if (value > 0) return '#15803d';
                if (value === 0) return '#374151';
                return '#991b1b';
            });

            charts.performanceRankingChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: sortedPlayers.map(([player]) => player),
                    datasets: [{
                        label: 'Score Performance (Positives - Négatives)',
                        data: performanceValues,
                        backgroundColor: backgroundColors,
                        borderColor: borderColors,
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const playerName = context.label;
                                    const stats = playerStats[playerName];
                                    return `${playerName}: ${stats.performance} (${stats.positive} pos. - ${stats.negative} nég.)`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            min: -scaledMax,
                            max: scaledMax,
                            grid: {
                                color: function(context) {
                                    return context.tick.value === 0 ? '#000000' : '#e5e7eb';
                                }
                            }
                        },
                        y: {
                            ticks: {
                                maxRotation: 0
                            }
                        }
                    }
                }
            });
        }

        function updateBalanceChart() {
            const { positiveActions, negativeActions } = categorizeActions();
            const playerStats = {};

            const players = [...new Set(filteredData.map(d => d.Joueur))];
            players.forEach(player => {
                playerStats[player] = { positive: 0, negative: 0 };
            });

            filteredData.forEach(d => {
                if (positiveActions.includes(d.Action)) {
                    playerStats[d.Joueur].positive++;
                } else if (negativeActions.includes(d.Action)) {
                    playerStats[d.Joueur].negative++;
                }
            });

            let balanced = 0;
            let positive = 0;
            let negative = 0;

            Object.values(playerStats).forEach(stats => {
                const performance = stats.positive - stats.negative;
                if (performance > 2) positive++;
                else if (performance < -2) negative++;
                else balanced++;
            });

            const ctx = document.getElementById('balanceChart').getContext('2d');
            if (charts.balanceChart) charts.balanceChart.destroy();

            charts.balanceChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Équilibrés (-2 à +2)', 'Performants (+2)', 'En difficulté (-2)'],
                    datasets: [{
                        data: [balanced, positive, negative],
                        backgroundColor: ['#6b7280', '#166534', '#dc2626'],
                        borderColor: ['#4b5563', '#15803d', '#991b1b'],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom' },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((context.parsed * 100) / total).toFixed(1);
                                    return `${context.label}: ${context.parsed} joueurs (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        function updateActionsByQuarterChart() {
            const allActions = [...new Set(filteredData.map(d => d.Action))].sort();

            // Ajouter les règles métier comme types d'actions
            const ruleActions = businessRules
                .filter(r => ruleMatches.some(m => m.ruleId === r.id))
                .map(r => `[RÈGLE] ${r.name}`);

            const actionTypes = [...allActions, ...ruleActions];
            const quarters = [...new Set(filteredData.map(d => d['Période']))].sort();

            const dataByQuarter = {};
            quarters.forEach(q => {
                dataByQuarter[q] = {};
                actionTypes.forEach(action => {
                    dataByQuarter[q][action] = 0;
                });
            });

            // Compter les actions normales
            filteredData.forEach(d => {
                const quarter = d['Période'];
                const action = d.Action;
                if (dataByQuarter[quarter] && dataByQuarter[quarter][action] !== undefined) {
                    dataByQuarter[quarter][action]++;
                }
            });

            // Ajouter les règles métier détectées par période
            ruleMatches.forEach(match => {
                const quarter = match.quarter;
                const ruleAction = `[RÈGLE] ${match.ruleName}`;

                if (!dataByQuarter[quarter]) {
                    dataByQuarter[quarter] = {};
                    actionTypes.forEach(action => {
                        dataByQuarter[quarter][action] = 0;
                    });
                }

                if (dataByQuarter[quarter][ruleAction] !== undefined) {
                    dataByQuarter[quarter][ruleAction]++;
                }
            });

            const colors = [
                '#3498db', '#2ecc71', '#e74c3c', '#f39c12', '#9b59b6',
                '#1abc9c', '#34495e', '#e67e22', '#95a5a6', '#d35400'
            ];

            const datasets = actionTypes.map((action, idx) => {
                // Couleur spéciale pour les règles métier
                const isRule = action.startsWith('[RÈGLE]');
                const ruleColor = isRule ? '#8b5cf6' : colors[idx % colors.length]; // Violet pour les règles

                return {
                    label: action,
                    data: quarters.map(q => dataByQuarter[q][action] || 0),
                    backgroundColor: ruleColor,
                    borderColor: ruleColor,
                    borderWidth: isRule ? 3 : 1 // Bordure plus épaisse pour les règles
                };
            });

            const ctx = document.getElementById('actionsByQuarterChart').getContext('2d');
            if (charts.actionsByQuarterChart) charts.actionsByQuarterChart.destroy();

            charts.actionsByQuarterChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: quarters,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                boxWidth: 12,
                                font: {
                                    size: 10
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            stacked: true,
                            title: {
                                display: true,
                                text: 'Période'
                            }
                        },
                        y: {
                            stacked: true,
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Nombre d\'actions'
                            }
                        }
                    }
                }
            });
        }

        function updateActionsByMatchChart() {
            const allActions = [...new Set(filteredData.map(d => d.Action))].sort();

            // Ajouter les règles métier comme types d'actions
            const ruleActions = businessRules
                .filter(r => ruleMatches.some(m => m.ruleId === r.id))
                .map(r => `[RÈGLE] ${r.name}`);

            const actionTypes = [...allActions, ...ruleActions];
            const matches = [...new Set(filteredData.map(d => `${d.Date} vs ${d.Adversaire}`))].sort();

            const dataByMatch = {};
            matches.forEach(match => {
                dataByMatch[match] = {};
                actionTypes.forEach(action => {
                    dataByMatch[match][action] = 0;
                });
            });

            // Compter les actions normales
            filteredData.forEach(d => {
                const matchKey = `${d.Date} vs ${d.Adversaire}`;
                const action = d.Action;
                if (dataByMatch[matchKey] && dataByMatch[matchKey][action] !== undefined) {
                    dataByMatch[matchKey][action]++;
                }
            });

            // Ajouter les règles métier détectées par match
            ruleMatches.forEach(match => {
                const matchKey = `${match.date} vs ${match.adversaire}`;
                const ruleAction = `[RÈGLE] ${match.ruleName}`;

                if (!dataByMatch[matchKey]) {
                    dataByMatch[matchKey] = {};
                    actionTypes.forEach(action => {
                        dataByMatch[matchKey][action] = 0;
                    });
                }

                if (dataByMatch[matchKey][ruleAction] !== undefined) {
                    dataByMatch[matchKey][ruleAction]++;
                }
            });

            const colors = [
                '#3498db', '#2ecc71', '#e74c3c', '#f39c12', '#9b59b6',
                '#1abc9c', '#34495e', '#e67e22', '#95a5a6', '#d35400'
            ];

            const datasets = actionTypes.map((action, idx) => {
                // Couleur spéciale pour les règles métier
                const isRule = action.startsWith('[RÈGLE]');
                const ruleColor = isRule ? '#8b5cf6' : colors[idx % colors.length]; // Violet pour les règles

                return {
                    label: action,
                    data: matches.map(match => dataByMatch[match][action] || 0),
                    backgroundColor: ruleColor,
                    borderColor: ruleColor,
                    borderWidth: isRule ? 3 : 1 // Bordure plus épaisse pour les règles
                };
            });

            const ctx = document.getElementById('actionsByMatchChart').getContext('2d');
            if (charts.actionsByMatchChart) charts.actionsByMatchChart.destroy();

            charts.actionsByMatchChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: matches,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                boxWidth: 12,
                                font: {
                                    size: 10
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            stacked: true,
                            ticks: {
                                maxRotation: 45,
                                minRotation: 45
                            },
                            title: {
                                display: true,
                                text: 'Match'
                            }
                        },
                        y: {
                            stacked: true,
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Nombre d\'actions'
                            }
                        }
                    }
                }
            });
        }

        function updatePlayersGrid() {
            const playersContainer = document.getElementById('playersGrid');
            const playerStats = {};

            // Calculer les stats de manière dynamique
            filteredData.forEach(d => {
                if (!playerStats[d.Joueur]) {
                    playerStats[d.Joueur] = {
                        numero: d.Numéro,
                        totalActions: 0,
                        actions: {} // Compteur pour chaque action
                    };
                }

                playerStats[d.Joueur].totalActions++;

                // Compter chaque action dynamiquement
                const action = d.Action;
                if (!playerStats[d.Joueur].actions[action]) {
                    playerStats[d.Joueur].actions[action] = 0;
                }
                playerStats[d.Joueur].actions[action]++;
            });

            if (Object.keys(playerStats).length === 0) {
                playersContainer.innerHTML = '<div class="no-data">Aucune donnée disponible avec les filtres actuels</div>';
                return;
            }

            const sortedPlayers = Object.entries(playerStats)
                .sort((a, b) => b[1].totalActions - a[1].totalActions);

            playersContainer.innerHTML = sortedPlayers.map(([player, stats]) => {
                // Construire dynamiquement les stats visibles en fonction de selectedStats
                const statsHtml = selectedStats.map(action => {
                    const count = stats.actions[action] || 0;
                    return `
                        <div class="player-stat">
                            <div class="player-stat-value">${count}</div>
                            <div class="player-stat-label">${action}</div>
                        </div>
                    `;
                }).join('');

                return `
                    <div class="player-card">
                        <div class="player-header">
                            <div class="player-name">${player}</div>
                            <div class="player-number">#${stats.numero}</div>
                        </div>
                        <div class="player-stats">
                            ${statsHtml}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function populateStatsFilters() {
            // Extraire toutes les actions uniques du dataset
            const uniqueActions = [...new Set(basketballData.map(d => d.Action))].sort();

            // Initialiser selectedStats avec toutes les actions
            selectedStats = [...uniqueActions];

            // Générer les boutons
            const container = document.getElementById('statsFilterContainer');
            container.innerHTML = uniqueActions.map(action => {
                // Échapper les guillemets pour éviter les problèmes JavaScript
                const escapedAction = action.replace(/'/g, "\\'");
                return `
                    <button class="stat-filter-btn active" data-stat="${action}" onclick="toggleStatFilterByButton(this)">
                        ${action}
                    </button>
                `;
            }).join('');
        }

        function toggleStatFilterByButton(btn) {
            const stat = btn.getAttribute('data-stat');
            toggleStatFilter(stat, btn);
        }

        function toggleStatFilter(stat, btn) {
            if (!btn) {
                btn = document.querySelector(`[data-stat="${stat}"]`);
            }

            if (selectedStats.includes(stat)) {
                // Retirer la stat
                selectedStats = selectedStats.filter(s => s !== stat);
                btn.classList.remove('active');
            } else {
                // Ajouter la stat
                selectedStats.push(stat);
                btn.classList.add('active');
            }

            // Rafraîchir l'affichage des joueurs
            updatePlayersGrid();
        }

        function exportFilteredData() {
            if (filteredData.length === 0) {
                alert('Aucune donnée à exporter avec les filtres actuels.');
                return;
            }

            const csvContent = "data:text/csv;charset=utf-8,"
                + "Date,Adversaire,Joueur,Numéro,Période,Temps,Action\n"
                + filteredData.map(row =>
                    `${row.Date},${row.Adversaire},${row.Joueur},${row.Numéro},${row['Période']},${row.Temps},${row.Action}`
                ).join("\n");

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "analyse_basketball_filtree.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
    </script>
</body>
</html>
